<h2 class="component">All Events</h2>

<div class="view-toggle" role="group" aria-label="View mode">
  <button class="btn btn-sm" [class.btn-purple]="viewMode() === 'table'"
          [class.btn-outline-secondary]="viewMode() === 'card'" (click)="viewMode.set('table')" aria-label="Table view"
          [attr.aria-pressed]="viewMode() === 'table'">
    <i class="pi pi-table" aria-hidden="true"></i>
  </button>
  <button class="btn btn-sm" [class.btn-purple]="viewMode() === 'card'"
          [class.btn-outline-secondary]="viewMode() === 'table'" (click)="viewMode.set('card')" aria-label="Card view"
          [attr.aria-pressed]="viewMode() === 'card'">
    <i class="pi pi-th-large" aria-hidden="true"></i>
  </button>
</div>

<div class="table-wrapper" [class.card-view]="viewMode() === 'card'">
  <p-table
    [value]="events()"
    [loading]="loading()"
    [paginator]="true"
    [rows]="environment.defaultPageSize"
    [totalRecords]="totalRecords()"
    [lazy]="true"
    (onLazyLoad)="onPageChange($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th scope="col"></th>
        <th scope="col" aria-label="ID">ID</th>
        <th scope="col" aria-label="Title">Title</th>
        <th scope="col" aria-label="Description">Description</th>
        <th scope="col" aria-label="Location">Location</th>
        <th scope="col" aria-label="Date">Date</th>
        <th scope="col" aria-label="Time">Time</th>
        <th scope="col" aria-label="Visibility">Visibility</th>
        <th scope="col" aria-label="Number of participants"># Participants</th>
        <th scope="col" aria-label="Number of comments"># Comments</th>
        <th scope="col" aria-label="Number of media"># Media</th>
        <th scope="col" aria-label="Edit"></th>
        <th scope="col" aria-label="Delete"></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-event>
      <tr>
        <td data-label="">
          <a [routerLink]="getEventRouterLink(event.id)">
            <img
              [src]="(UrlUtilService.getMediaUrl(event.pictureURI || environment.eventDummyCoverPicRelativeUrl)   | secureImage | async) || ''"
              [alt]="'Cover picture of the event ' + event.title"
              class="mediaItem-thumbnail"
            />
            <span class="card-view-title">{{ getTextPreview(event.title, 31) }}</span>
          </a>
        </td>

        <td data-label="ID"><span class="p-column-title"><small>{{ event.id }}</small></span></td>
        <td data-label="Title"><span class="p-column-title">{{ event.title }}</span></td>

        <!-- Description with view more button -->
        <td data-label="Description" class="description-cell">
          <span class="p-column-title">
          <div class="description-content">
            <div class="description-preview">
              {{ getEventDescriptionPreview(event.description, environment.eventDescriptionPreviewLength) }}
            </div>
            @if (shouldShowViewMore(event.description)) {
              <button
                type="button"
                class="view-more-btn"
                (click)="viewFullDescription(event)"
                title="View full description">
                <i class="pi pi-eye"></i>
                View
              </button>
            }
          </div>
            </span>
        </td>

        <td data-label="Location"><span class="p-column-title">{{ event.location }}</span></td>
        <td data-label="Date"><span class="p-column-title">{{ event.date | date:'EEE, MMMM d, y' }}</span></td>
        <td data-label="Time"><span class="p-column-title">{{ event.date | date:'h:mm a' }}</span></td>

        <td data-label="Visibility">
          <span class="p-column-title">
            <p-tag
              [icon]="event.isPrivateEvent ? 'pi pi-lock' : 'pi pi-globe'"
              [severity]="event.isPrivateEvent ? 'warn' : 'success'"
              [value]="event.isPrivateEvent ? 'Private' : 'Public'">
            </p-tag>
          </span>
        </td>

        <td data-label="Participants"><span class="p-column-title">{{ event.participantCount }}</span></td>
        <td data-label="Comments"><span class="p-column-title">{{ event.commentCount }}</span></td>
        <td data-label="Media"><span class="p-column-title">{{ event.mediaCount }}</span></td>

        <td data-label="Edit">
          <i class="pi pi-pencil clickable" title="Edit" (click)="onEdit(event)" aria-label="Edit event"></i>
        </td>
        <td data-label="Delete">
          <i class="pi pi-trash clickable" title="Delete" (click)="onDelete(event)" aria-label="Delete event"></i>
        </td>
      </tr>
    </ng-template>
  </p-table>

  @if (loading()) {
    <app-spinner type="overlay" message="Loading events..."/>
  }
</div>

<!-- Description Dialog -->
<p-dialog
  [(visible)]="showDescriptionDialog"
  [header]="selectedEvent?.title"
  [modal]="true"
  [style]="{width: '600px', maxWidth: '90vw'}"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false">

  <div class="dialog-content">
    <!-- Event image -->
    @if (selectedEvent) {
      <img
        [src]="(UrlUtilService.getMediaUrl(selectedEvent.pictureURI || environment.eventDummyCoverPicRelativeUrl)  | secureImage | async) || ''"
        [alt]="'Cover picture of ' + selectedEvent.title"
        class="dialog-image"
      />
    }

    <!-- Full description -->
    <div class="full-description">
      <h4>Description</h4>
      <p>{{ selectedEvent?.description }}</p>
    </div>

    <!-- Additional info -->
    <div class="event-details">
      <div class="detail-row">
        <i class="pi pi-map-marker"></i>
        <span>{{ selectedEvent?.location }}</span>
      </div>
      <div class="detail-row">
        <i class="pi pi-calendar"></i>
        <span>{{ selectedEvent?.date | date:'EEE, MMMM d, y' }}</span>
      </div>
      <div class="detail-row">
        <i class="pi pi-clock"></i>
        <span>{{ selectedEvent?.date | date:'h:mm a' }}</span>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer-buttons">
      <p-button
        label="Close"
        icon="pi pi-times"
        (onClick)="showDescriptionDialog = false"
        styleClass="p-button-text"
      >
      </p-button>
      <p-button
        label="View Event"
        icon="pi pi-external-link"
        [routerLink]="getEventRouterLink(selectedEvent!.id)"
        (onClick)="showDescriptionDialog = false"
      >
      </p-button>
    </div>
  </ng-template>
</p-dialog>
