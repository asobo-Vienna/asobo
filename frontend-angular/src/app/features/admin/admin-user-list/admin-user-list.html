<h2 class="component">All Users</h2>

<div class="view-toggle" role="group" aria-label="View mode">
  <button class="btn btn-sm" [class.btn-purple]="viewMode() === 'table'"
          [class.btn-outline-secondary]="viewMode() === 'card'" (click)="viewMode.set('table')" aria-label="Table view"
          [attr.aria-pressed]="viewMode() === 'table'">
    <i class="pi pi-table" aria-hidden="true"></i>
  </button>
  <button class="btn btn-sm" [class.btn-purple]="viewMode() === 'card'"
          [class.btn-outline-secondary]="viewMode() === 'table'" (click)="viewMode.set('card')" aria-label="Card view"
          [attr.aria-pressed]="viewMode() === 'card'">
    <i class="pi pi-th-large" aria-hidden="true"></i>
  </button>
</div>

<div class="table-wrapper" [class.card-view]="viewMode() === 'card'">
  <p-table
    [value]="users()"
    [loading]="loading()"
    [paginator]="true"
    [rows]="environment.defaultPageSize"
    [totalRecords]="totalRecords()"
    [lazy]="true"
    (onLazyLoad)="onPageChange($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th scope="col"></th>
        <th scope="col" aria-label="ID">ID</th>
        <th scope="col" aria-label="Username">Username</th>
        <th scope="col" aria-label="Email">Email</th>
        <th scope="col" aria-label="Name">Name</th>
        <th scope="col" aria-label="Registered">Registered</th>
        <th scope="col" aria-label="Active">Active</th>
        <th scope="col" aria-label="Location">Location</th>
        <th scope="col" aria-label="Country">Country</th>
        <th scope="col" aria-label="Roles">Roles</th>
        <th scope="col" aria-label="Edit"></th>
        <th scope="col" aria-label="Delete"></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-user>
      <tr>
        <td data-label="">
          <a [routerLink]="UrlUtilService.getUserRouterLink(user.username)">
            <img
              [src]="(UrlUtilService.getMediaUrl(user.pictureURI || environment.userDummyProfilePicRelativeUrl)  | secureImage | async) || ''"
              [alt]="user.username + '\'s avatar'"
              class="user-avatar"
            />
            <span class="card-view-title">{{ user.username }}</span>
          </a>
        </td>

        <td data-label="ID"><span class="p-column-title"><small>{{ user.id }}</small></span></td>
        <td data-label="Username"><span class="p-column-title">{{ user.username }}</span></td>
        <td data-label="Email"><span class="p-column-title">{{ user.email }}</span></td>
        <td data-label="Name"><span class="p-column-title">{{ user.firstName }} {{ user.surname }}</span></td>
        <td data-label="Registered"><span class="p-column-title">{{ user.registerDate | date:'yyyy-MM-dd' }}</span></td>

        <td data-label="Active">
          <span class="p-column-title">
            <p-tag
              [value]="user.isActive ? 'Active' : 'Inactive'"
              [severity]="user.isActive ? 'success' : 'danger'"
            />
          </span>
        </td>

        <td data-label="Location"><span class="p-column-title">{{ user.location }}</span></td>

        <td data-label="Country"><span class="p-column-title">{{ user.country }}</span></td>

        <td data-label="Roles">
          <span class="p-column-title">
          <div class="flex flex-col gap-1">
            <p-multiselect
              [options]="allRoles()"
              optionLabel="name"
              placeholder="View/Edit Roles"
              [fluid]="true"
              [ngModel]="getUserRoles(user)"
              (ngModelChange)="onRolesChange($event, user)"
              dataKey="id"
              [filter]="true"
              [showToggleAll]="false"
              [maxSelectedLabels]="allRoles().length"
              [selectedItemsLabel]="'View/Edit Roles'"
              display="chip">
              <ng-template pTemplate="selectedItems" let-selectedItems>
                @for (role of selectedItems; track role) {
                  <p-chip
                    [label]="role.name"
                    [removable]="role.name !== 'USER'"
                    (onRemove)="handleChipRemove(role, user)">
                  </p-chip>
                }
              </ng-template>
            </p-multiselect>
          </div>
            </span>
        </td>

        @if (!user.isDeleted) {
          <td data-label="Edit">
            <span class="p-column-title">
              <i class="pi pi-user-edit clickable" title="Edit" (click)="onEdit(user)" aria-label="Edit user"></i>
            </span>
          </td>
          <td data-label="Delete">
            <span class="p-column-title">
              <i class="pi pi-trash clickable" title="Delete" (click)="onDelete(user)" aria-label="Delete user"></i>
            </span>
          </td>
        } @else {
          <td data-label=""></td>
          <td data-label="Reactivate">
            <span class="p-column-title">
              <i class="pi pi-power-off clickable" title="Reactivate" (click)="onReactivate(user)"
                 aria-label="Reactivate user"></i>
            </span>
          </td>
        }
      </tr>
    </ng-template>
  </p-table>

  @if (loading()) {
    <app-spinner type="overlay" message="Loading users..."/>
  }
</div>
